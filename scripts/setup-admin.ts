import { config } from "dotenv";
import { neon } from "@neondatabase/serverless";
import { drizzle } from "drizzle-orm/neon-http";
import { usersTable } from "../shared/schema";
import { eq } from "drizzle-orm";
import { randomUUID } from "crypto";

// Carregar vari√°veis de ambiente
config();

// Script para gerenciar usu√°rios admin
async function manageAdmin() {
  try {
    // Verificar se DATABASE_URL est√° configurada
    if (!process.env.DATABASE_URL) {
      console.log("‚ùå DATABASE_URL n√£o est√° configurada!");
      console.log("\nüîß Para configurar:");
      console.log("1. Crie um arquivo .env na raiz do projeto");
      console.log("2. Adicione: DATABASE_URL=postgresql://...");
      console.log("3. Ou execute: export DATABASE_URL=postgresql://...");
      return;
    }

    const sql = neon(process.env.DATABASE_URL);
    const db = drizzle(sql);

    const email = "leo@dev.com";
    
    // Buscar usu√°rio
    const existingUser = await db
      .select()
      .from(usersTable)
      .where(eq(usersTable.email, email))
      .limit(1);

    if (existingUser.length === 0) {
      // Criar usu√°rio admin se n√£o existir
      console.log(`üÜï Criando usu√°rio admin: ${email}`);
      
      const newUser = await db
        .insert(usersTable)
        .values({
          id: randomUUID(),
          email: email,
          name: "Leonardo Admin",
          passwordHash: "temp-password-hash", // Placeholder - auth ser√° feita via OAuth
          isAdmin: true,
          createdAt: new Date(),
          updatedAt: new Date()
        })
        .returning();

      console.log(`‚úÖ Usu√°rio admin criado com sucesso!`);
      console.log(`üìß Email: ${newUser[0].email}`);
      console.log(`üë§ Nome: ${newUser[0].name}`);
      console.log(`üëë Admin: ${newUser[0].isAdmin}`);
      
    } else {
      const user = existingUser[0];
      console.log(`\nüìã Usu√°rio encontrado: ${email}`);
      console.log(`üë§ Nome: ${user.name}`);
      console.log(`üëë Admin: ${user.isAdmin ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
      console.log(`üìÖ Criado: ${user.createdAt}`);

      if (!user.isAdmin) {
        console.log(`\nüîÑ Tornando usu√°rio admin...`);
        
        await db
          .update(usersTable)
          .set({ 
            isAdmin: true,
            updatedAt: new Date()
          })
          .where(eq(usersTable.email, email));

        console.log(`‚úÖ Usu√°rio ${email} agora √© admin!`);
      }
    }

  } catch (error) {
    console.error("‚ùå Erro:", error);
  }
}

// Mostrar instru√ß√µes se DATABASE_URL n√£o estiver configurada
console.log("üîç Verificando configura√ß√£o e status de admin...\n");

manageAdmin()
  .then(() => {
    console.log("\n‚úÖ Processo conclu√≠do");
    process.exit(0);
  })
  .catch((error) => {
    console.error("‚ùå Erro:", error);
    process.exit(1);
  });